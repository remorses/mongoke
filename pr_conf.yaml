

db_url: mongodb://localhost:27017/playdb
root_dir_path: ./generated

jwt:
    secret: ''
    algorithms: [H256]

skema: |
    Bot:
        _id: ObjectId
        user_id: ObjectId
        username: Str
    User:
        bot_id: ObjectId
        name: Str
        surname: Str
    MessageCampaign:
        _id: ObjectId
        bot_id: ObjectId
        messages: [Str]
    PostCampaign:
        _id: ObjectId
        bot_id: ObjectId
        posts: [Str]
    Campaign: MessageCampaign | PostCampaign
    EventWindow:
        value: Int
        timestamp: Int
    Event:
        _id: ObjectId
        bot_id: ObjectId
        type: "like" | "bo"
        likes?: Int
        timestamp: 0..
    ObjectId: Any # this will be added implictely
    ID: Any
# skema_url: https://gist.githubusercontent.com/remorses/4f591ebbd772545147ba1b3a334b631e/raw/social-automata-domain.skema



types:
    User:
        exposed: False
        collection: users
    Bot:
        collection: bots
        pipeline:
            - $set:
                user_id: fucku
        # guards:
        #     -   expression: where.get('user_id') == jwt.get('user_id')
        #         excluded: ["ciao"]
        #         when: before
            # -   expression: x['user_id'] == where.get('_id')
            #     excluded: ["ciao"]
            #     when: after
    Campaign:
        collection: campaigns
        disambiguations:
            MessageCampaign: >
                'messages' in x
            PostCampaign: >
                'posts' in x
        pipeline:
            - $project:
                _id: 0
                username: 0
    EventWindow:
        exposed: False
        collection: events
        pipeline:
            -   $group:
                    _id:
                        $subtract:
                            - $timestamp
                            - $mod: [$timestamp, 10] # minute 60 * 1000
                    value: 
                        $sum:
                            $value
            
            -   $project:
                    timestamp: $_id
                    value: 1

relations:
    -   from: Bot
        to: EventWindow
        relation_type: to_many
        field: likes_over_time
        query: {}
    -   from: Bot
        to: User
        field: user
        relation_type: to_one
        query:
            _id: ${{ parent.get('_id') }}


